// What I have changed
// 1. remove pHNowVariable.
// 2. Remove F R T pHs value.
// 3. reading array is redundant.

// Assigning pin to different uses
int basePump = P2_1; // pin use for analogWrite for the base pump
int acidPump = P2_2; // pin use for analogWrite for the acid pump
int pHInput = P1_7;  // pin use for analogRead for pH probe
int vOffset = P1_5;  // pin use to provide offset to pH probe

// Range of the pH value
int maxpH=6;
int minpH=4;

// Averaging the readings from the pH probe
const int numReadings = 10;
int idx = 0;                 // the index of the current reading
double total = 0;            // the running total
double average = 0;          // the average

// Constant the in pH equations
// double pHs = 7;          //pH of standard solution = 7
// double F = 9.6485309e4;  //Faraday Constant
// double R = 8.314510;     // Universal gas constant

// Variable which we measure
// double T = 293;             // Temperature in KelpHInput given by the heating group
double voltage = 0;         // voltage between electrode (Es -Ex)
double pHNow = 0;           // pH of the unknown solution(x), initialize it as 0

void setup() {
  Serial.begin(9600);

  // Setup
  pinMode(basePump, OUTPUT);
  pinMode(acidPump, OUTPUT);
  pinMode(pHInput, INPUT);
  pinMode(vOffset, INPUT);
}

void loop() {
  digitalWrite(basePump, LOW);
  digitalWrite(acidPump, LOW);

  voltage = (analogRead(vOffset))*(3.0/1023) - (analogRead(pHInput)/1023.0); // map the value from 0 to 1023 levels, 0 to 3 V, then take away the offset

  pHNow = 7 + (voltage*9.6485309e4/(8.314510*293*logf(10)));

  total = total + pHNow;
  idx = idx + 1;
 
  average = total/idx;

  if (average > 14) {
    average = 14;
  } else if (average < 0) {
    average = 0;
  }

  // Reset the data.
  if (idx % 10 == 0)
  {
    total = 0;
    idx = 0;
  }

  Serial.print("Average Value = ");
  Serial.println(average);

  if (average > maxpH){
    digitalWrite(acidPump,HIGH);
    delay(20);
    analogWrite(acidPump, 220);
    delay(100);
    digitalWrite(acidPump,LOW);
  } else if (average < minpH){
    digitalWrite(basePump,HIGH);
    delay(120);
    digitalWrite(basePump,LOW);
  } else {
    delay(120);
  }


//activating the pump
  delay(1000);  // use 0.1 second delay for testing
}
